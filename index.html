<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>StandBy â€” Clock Â· Weather Â· Music</title>
<meta name="theme-color" content="#ffffff" />
<style>
:root{--bg1:#f5f9fc;--glass:rgba(255,255,255,0.06);--glass-2:rgba(255,255,255,0.04);--stroke:rgba(255,255,255,0.12);--accent:#ffffff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'SF Pro Text', 'Helvetica Neue', Arial;color:var(--accent);background:linear-gradient(180deg,#e8f0f7,#f5f9fc);-webkit-font-smoothing:antialiased}
body{display:flex;align-items:center;justify-content:center;overflow:hidden}
.app{width:100vw;height:100vh;display:flex;align-items:stretch;justify-content:center;padding:28px}
.container{width:100%;height:100%;display:grid;gap:28px;align-items:center;justify-items:stretch}
/* adaptive layout: landscape vs portrait */
.container.landscape{grid-template-columns:1fr 420px;grid-template-rows:1fr}
.container.portrait{grid-template-columns:1fr;grid-template-rows:auto 1fr;align-items:start}
/* left big clock card */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:22px;padding:28px;backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);border:1px solid var(--stroke);display:flex;flex-direction:column;justify-content:center}
.clock{display:flex;flex-direction:column;gap:6px}
.time{font-weight:300;letter-spacing:-4px}
.date{opacity:0.9;font-weight:400}
/* right weather card */
.weather-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:18px;padding:20px;backdrop-filter:blur(14px);border:1px solid var(--stroke);display:flex;flex-direction:column;gap:12px}
.weather-top{display:flex;align-items:center;gap:16px}
.temp-ct{display:flex;flex-direction:column}
.temp{font-weight:200}
.cond{opacity:0.95}
.forecast-row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:4px}
.f-day{width:54px;background:rgba(255,255,255,0.02);border-radius:10px;padding:8px;text-align:center;border:1px solid rgba(255,255,255,0.04)}
.f-day .d{font-size:12px}
.f-day img{width:28px;height:28px}
/* spotify mini player (floating) */
#spotify-now{position:fixed;left:20px;bottom:20px;z-index:2000;display:flex;align-items:center;gap:12px;background:linear-gradient(90deg, rgba(0,0,0,0.42), rgba(0,0,0,0.28));padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(8px)}
#sp-cover{width:56px;height:56px;border-radius:8px;object-fit:cover}
#sp-meta{display:flex;flex-direction:column;min-width:0}
#sp-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#sp-artist{font-size:12px;opacity:0.9}
#sp-progress{height:5px;background:rgba(255,255,255,0.08);border-radius:6px;margin-top:6px;overflow:hidden}
#sp-progress-fill{height:100%;width:0%;background:var(--accent);transition:width .25s linear}
#sp-controls{display:flex;gap:6px;margin-top:6px}
#sp-controls button{background:transparent;border:none;color:var(--accent);font-size:16px;cursor:pointer;opacity:0.9}
#spotify-login{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);cursor:pointer}
/* small screens */
@media (max-width:900px){.container.landscape{grid-template-columns:1fr} .container{padding:16px} #spotify-now{left:12px;bottom:12px} .f-day{width:48px}}
/* adaptive font sizes for tablet always-on */
/* we'll set sizes via JS depending on orientation */
</style>
</head>
<body>
<div class="app">
  <div id="container" class="container landscape">
    <div id="left" class="card clock-card card" aria-hidden="false">
      <div class="clock">
        <div id="time" class="time" style="font-size: clamp(60px, 12vw, 200px);">--:--</div>
        <div id="date" class="date" style="font-size: clamp(18px, 2.4vw, 28px);">Loadingâ€¦</div>
      </div>
    </div>

    <div id="right" class="weather-card">
      <div class="weather-top">
        <div style="display:flex;flex-direction:column;align-items:flex-start">
          <div id="temp" class="temp" style="font-size: clamp(36px, 8vw, 64px);">--<span class="unit">Â°</span></div>
          <div id="desc" class="cond" style="font-size:16px">â€”</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div id="location" style="font-weight:500;opacity:0.95">Santa Rosa Beach, FL</div>
          <div id="updated" style="font-size:12px;opacity:0.8">--</div>
        </div>
      </div>
      <div id="forecast" class="forecast-row" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- spotify UI -->
<div id="spotify-now" style="display:none" aria-live="polite">
  <img id="sp-cover" src="" alt="cover" />
  <div id="sp-meta">
    <div id="sp-title">â€”</div>
    <div id="sp-artist">â€”</div>
    <div id="sp-progress"><div id="sp-progress-fill"></div></div>
    <div id="sp-controls"><button id="sp-prev">â®</button><button id="sp-play">â¯</button><button id="sp-next">â­</button></div>
  </div>
  <div id="sp-hide" style="margin-left:8px;cursor:pointer;opacity:0.9">âœ•</div>
</div>
<button id="spotify-login">Login to Spotify</button>

<script>
// ---------- Responsive behavior & wake lock ----------
const container = document.getElementById('container');
function applyLayout(){
  const w = window.innerWidth, h = window.innerHeight;
  if (w >= h) { // landscape
    container.classList.remove('portrait'); container.classList.add('landscape');
    document.documentElement.style.setProperty('--accent','#ffffff');
  } else {
    container.classList.remove('landscape'); container.classList.add('portrait');
    document.documentElement.style.setProperty('--accent','#ffffff');
  }
  // adjust typography scales handled by clamp()
}
applyLayout(); window.addEventListener('resize',applyLayout);

// Try to acquire wake lock to keep screen awake on supported browsers
let wakeLock = null;
async function requestWakeLock(){
  try{ if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); }
  catch(e){ console.warn('Wake Lock failed', e); }
}
requestWakeLock();

// ---------- Clock ----------
function updateClock(){
  const d = new Date();
  let h = d.getHours();
  const ap = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  const mins = String(d.getMinutes()).padStart(2,'0');
  document.getElementById('time').innerHTML = `${h}:${mins} <span style="font-size:0.26em;opacity:0.9;">${ap}</span>`;
  document.getElementById('date').textContent = d.toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
}
updateClock(); setInterval(updateClock, 1000);

// ---------- Weather (open-meteo) with midday fix and icons in ./icons/ ----------
const CODE = {0:['Clear','â˜€ï¸'],1:['Mainly clear','ğŸŒ¤ï¸'],2:['Partly cloudy','â›…'],3:['Overcast','â˜ï¸'],45:['Fog','ğŸŒ«ï¸'],48:['Depositing rime fog','ğŸŒ«ï¸'],51:['Light drizzle','ğŸŒ¦ï¸'],52:['Moderate drizzle','ğŸŒ¦ï¸'],53:['Dense drizzle','ğŸŒ¦ï¸'],56:['Freezing drizzle','ğŸŒ§ï¸'],57:['Dense freezing drizzle','ğŸŒ§ï¸'],61:['Slight rain','ğŸŒ§ï¸'],63:['Moderate rain','ğŸŒ§ï¸'],65:['Heavy rain','ğŸŒ§ï¸'],66:['Freezing rain','ğŸŒ§ï¸'],67:['Heavy freezing rain','ğŸŒ§ï¸'],71:['Slight snow','â„ï¸'],73:['Moderate snow','â„ï¸'],75:['Heavy snow','â„ï¸'],77:['Snow grains','â„ï¸'],80:['Slight rain showers','ğŸŒ¦ï¸'],81:['Moderate rain showers','ğŸŒ¦ï¸'],82:['Violent rain showers','â›ˆï¸'],85:['Slight snow showers','ğŸŒ¨ï¸'],86:['Heavy snow showers','ğŸŒ¨ï¸'],95:['Thunderstorm','â›ˆï¸'],96:['Thunderstorm w/ slight hail','â›ˆï¸'],99:['Severe thunderstorm','â›ˆï¸']};

async function fetchWeather(){
  try{
    const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=30.3938&longitude=-86.2683&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=7', {cache:'no-store'});
    if(!r.ok) return;
    const d = await r.json();
    if(!d || !d.current_weather) return;
    const cw = d.current_weather;
    document.getElementById('temp').innerHTML = Math.round(cw.temperature) + '<span class="unit">Â°</span>';
    const mm = CODE[cw.weathercode] || ['Unknown','ğŸŒ¡ï¸'];
    document.getElementById('desc').textContent = mm[0] + (cw.is_day===0 ? ' (night)' : '');
    document.getElementById('updated').textContent = new Date().toLocaleString('en-US',{hour:'numeric',minute:'2-digit',weekday:'short',day:'numeric',month:'short'});

    if (d.daily && d.daily.time){
      const html = d.daily.time.map((dt,i)=>{
        const dtMid = dt + 'T12:00:00';
        const dd = new Date(dtMid);
        const dn = i===0 ? 'Today' : dd.toLocaleDateString('en-US',{weekday:'short'});
        const wcode = d.daily.weathercode[i];
        const wm = CODE[wcode] || ['Unknown','ğŸŒ¡ï¸'];
        const hi = Math.round(d.daily.temperature_2m_max[i]);
        const lo = Math.round(d.daily.temperature_2m_min[i]);
        const iconPath = './icons/'+wcode+'.svg';
        return `<div class="f-day"><div class="d">${dn}</div><div class="icon"><img src="${iconPath}" width="28" onerror="this.onerror=null;this.replaceWith(document.createTextNode('${wm[1]}'))"></div><div class="temps">${hi}Â° / ${lo}Â°</div></div>`;
      }).join('');
      document.getElementById('forecast').innerHTML = html;
    }
  }catch(e){ console.error('weather',e) }
}
fetchWeather(); setInterval(fetchWeather, 300000);

// ---------- Spotify PKCE & Now Playing (controls) ----------
const SPOTIFY_CLIENT_ID = '494ccfd29e8c424a84f5f71721f00033';
const REDIRECT_URI = 'https://balsammmmmmmm.github.io/time-weather/callback.html';
const SCOPES = 'user-read-currently-playing user-read-playback-state user-modify-playback-state';
const TOKEN_STORAGE_KEY = 'spotify_tokens_v1';

function randString(len=96){ const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~'; let s=''; const a=new Uint8Array(len); crypto.getRandomValues(a); for(let i=0;i<len;i++) s+=chars[a[i]%chars.length]; return s; }
async function sha256(msg){ const enc = new TextEncoder(); const data = enc.encode(msg); const h = await crypto.subtle.digest('SHA-256', data); return new Uint8Array(h); }
function base64urlEncode(buf){ let str=''; const chunk=0x8000; for(let i=0;i<buf.length;i+=chunk) str+=String.fromCharCode.apply(null, Array.from(buf.slice(i,i+chunk))); const b = btoa(str); return b.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }

async function startAuth(){ const code_verifier = randString(96); localStorage.setItem('spotify_code_verifier', code_verifier); const hashed = await sha256(code_verifier); const code_challenge = base64urlEncode(hashed); const url = new URL('https://accounts.spotify.com/authorize'); url.searchParams.set('response_type','code'); url.searchParams.set('client_id',SPOTIFY_CLIENT_ID); url.searchParams.set('scope',SCOPES); url.searchParams.set('redirect_uri',REDIRECT_URI); url.searchParams.set('code_challenge_method','S256'); url.searchParams.set('code_challenge',code_challenge); const state = randString(16); localStorage.setItem('spotify_auth_state', state); url.searchParams.set('state', state); window.location.href = url.toString(); }

function saveTokens(tokenObj){ const now = Date.now(); const expires_at = now + (tokenObj.expires_in ? tokenObj.expires_in*1000 : 3600*1000); const store = { access_token: tokenObj.access_token, refresh_token: tokenObj.refresh_token || (getStoredTokens()?.refresh_token || null), expires_at }; localStorage.setItem(TOKEN_STORAGE_KEY, JSON.stringify(store)); return store; }
function getStoredTokens(){ try{ return JSON.parse(localStorage.getItem(TOKEN_STORAGE_KEY)); }catch(e){return null;} }
function clearTokens(){ localStorage.removeItem(TOKEN_STORAGE_KEY); localStorage.removeItem('spotify_code_verifier'); localStorage.removeItem('spotify_auth_state'); }

async function refreshAccessToken(){ const store = getStoredTokens(); if(!store || !store.refresh_token) return null; const body = new URLSearchParams({ grant_type:'refresh_token', refresh_token: store.refresh_token, client_id: SPOTIFY_CLIENT_ID }); try{ const r = await fetch('https://accounts.spotify.com/api/token',{ method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: body.toString() }); if(!r.ok){ clearTokens(); updateSpotifyUI(null); return null;} const data = await r.json(); const saved = saveTokens(data); return saved; }catch(e){ console.error('refresh error', e); return null; } }

const loginBtn = document.getElementById('spotify-login');
const spNow = document.getElementById('spotify-now');
const spCover = document.getElementById('sp-cover');
const spTitle = document.getElementById('sp-title');
const spArtist = document.getElementById('sp-artist');
const spProgressFill = document.getElementById('sp-progress-fill');
const spHide = document.getElementById('sp-hide');
const btnPlay = document.getElementById('sp-play');
const btnNext = document.getElementById('sp-next');
const btnPrev = document.getElementById('sp-prev');

let nowPlayingTimer = null; const pollingInterval = 10000; let lastNowData = null; let lastFetchTime = 0; let progressTick = null;

loginBtn.addEventListener('click', ()=>{ const s = getStoredTokens(); if(s && s.access_token){ if(confirm('Log out from Spotify on this page?')){ clearTokens(); updateSpotifyUI(null);} } else startAuth(); });
spHide.addEventListener('click', ()=>{ if(getStoredTokens()){ if(confirm('Log out from Spotify on this page?')){ clearTokens(); updateSpotifyUI(null);} } else spNow.style.display='none'; });

async function callSpotifyEndpoint(method, endpoint, body=null){ const t = getStoredTokens(); if(!t) return; if(Date.now() > t.expires_at - 5000){ const ref = await refreshAccessToken(); if(!ref) return; } const token = getStoredTokens().access_token; try{ const r = await fetch('https://api.spotify.com/v1'+endpoint,{ method, headers:{ Authorization: 'Bearer '+token, 'Content-Type':'application/json' }, body: body ? JSON.stringify(body) : undefined }); return r; }catch(e){ console.error('spotify control error', e); }}

btnPlay.onclick = async ()=>{ if(lastNowData && lastNowData.is_playing) await callSpotifyEndpoint('PUT','/me/player/pause'); else await callSpotifyEndpoint('PUT','/me/player/play'); setTimeout(fetchNowPlaying,800); };
btnNext.onclick = async ()=>{ await callSpotifyEndpoint('POST','/me/player/next'); setTimeout(fetchNowPlaying,800); };
btnPrev.onclick = async ()=>{ await callSpotifyEndpoint('POST','/me/player/previous'); setTimeout(fetchNowPlaying,800); };

async function fetchNowPlaying(force=false){ const store = getStoredTokens(); if(!store){ updateSpotifyUI(null); return; } if(Date.now() > store.expires_at - 5000){ const ref = await refreshAccessToken(); if(!ref){ updateSpotifyUI(null); return; } } const token = getStoredTokens().access_token; try{ const r = await fetch('https://api.spotify.com/v1/me/player/currently-playing',{ headers:{ Authorization:'Bearer '+token } }); if(r.status===204){ updateSpotifyUI(null); return; } if(r.status===401){ const ref = await refreshAccessToken(); if(ref) return fetchNowPlaying(true); updateSpotifyUI(null); return; } if(!r.ok){ console.warn('now-playing status', r.status); updateSpotifyUI(null); return; } const data = await r.json(); lastNowData = data; lastFetchTime = Date.now(); updateSpotifyUI(data); }catch(e){ console.error('fetch now playing error', e); updateSpotifyUI(null); } }

function startProgressTick(){ if(progressTick) clearInterval(progressTick); progressTick = setInterval(()=>{ if(!lastNowData || !lastNowData.progress_ms || !lastNowData.item) return; const elapsed = Date.now() - lastFetchTime; const current = (lastNowData.progress_ms || 0) + elapsed; const duration = lastNowData.item.duration_ms || 1; let pct = Math.min(100, (current / duration) * 100); spProgressFill.style.width = pct + '%'; btnPlay.textContent = lastNowData.is_playing ? 'â¸' : 'â¯'; }, 500); }
function stopProgressTick(){ if(progressTick){ clearInterval(progressTick); progressTick = null; } }

function updateSpotifyUI(data){ const stored = getStoredTokens(); loginBtn.textContent = stored && stored.access_token ? 'Logout (Spotify)' : 'Login to Spotify'; if(!stored){ spNow.style.display='none'; stopProgressTick(); return; } if(!data || !data.item){ spNow.style.display='flex'; spTitle.textContent='Not playing'; spArtist.textContent=''; spCover.src=''; spProgressFill.style.width='0%'; btnPlay.textContent='â¯'; stopProgressTick(); return; } const item = data.item; const artists = (item.artists||[]).map(a=>a.name).join(', '); const title = item.name || 'Unknown'; const cover = (item.album && item.album.images && item.album.images[0] && item.album.images[0].url) || ''; spNow.style.display='flex'; spTitle.textContent = title; spArtist.textContent = artists; spCover.src = cover; const progressMs = data.progress_ms || 0; const duration = item.duration_ms || 1; const pct = Math.min(100, (progressMs / duration) * 100); spProgressFill.style.width = pct + '%'; btnPlay.textContent = data.is_playing ? 'â¸' : 'â¯'; startProgressTick(); }

function startPolling(){ if(nowPlayingTimer) clearInterval(nowPlayingTimer); fetchNowPlaying(); nowPlayingTimer = setInterval(fetchNowPlaying, pollingInterval); }
function stopPolling(){ if(nowPlayingTimer){ clearInterval(nowPlayingTimer); nowPlayingTimer = null; } }
(function initSpotify(){ const s = getStoredTokens(); if(s && s.access_token) startPolling(); else spNow.style.display='none'; if(s) updateSpotifyUI(null); })();

// Keep spotify UI visible when logged in
(function restoreSpotifyVisibility(){ const s = getStoredTokens(); if(s && s.access_token) document.getElementById('spotify-now').style.display = 'flex'; })();

</script>
</body>
</html>
