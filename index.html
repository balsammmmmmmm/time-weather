<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Clock + Weather + Spotify</title>
<meta name="theme-color" content="#000000" />
<style>
/* Reset + base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;min-height:100vh;font-family:Inter,system-ui,-apple-system,sans-serif;overflow:hidden;position:fixed;width:100%}

/* Dark background */
body{background:#000;color:#e6eef8;display:flex;align-items:center;justify-content:center;top:0;left:0;right:0;bottom:0}
.bg{display:none}
.bg.active{display:none}

/* Container */
.wrap{position:relative;z-index:1;width:100%;max-width:1400px;padding:24px;display:flex;flex-direction:column;gap:20px;align-items:center}

/* Card: two-column layout 65% / 35% */
.card{width:95%;max-width:1200px;display:grid;grid-template-columns:65% 35%;gap:16px;padding:20px;border-radius:8px;background:#000;border:0;box-shadow:none}
.main{padding:10px;display:flex;flex-direction:column;gap:12px}
.sidebar{padding:10px;display:flex;flex-direction:column;gap:10px}

/* Clock */
.clock{display:flex;flex-direction:column;gap:6px}
.time{font-weight:300;font-size:100px;line-height:.9;letter-spacing:-2px;color:#fff}
.ampm{font-size:.35em;margin-left:6px}
.date{font-size:1.2rem;color:#cfdff6;font-weight:300}

/* Hours grid (left column) */
.hours{display:grid;grid-template-columns:repeat(auto-fit,minmax(84px,1fr));gap:8px;margin-top:6px}
.hour{background:#0a0a0a;padding:8px;border-radius:6px;text-align:center;color:#dfefff}
.hour .t{font-weight:600}
.hour .temp{opacity:.9;margin-top:6px}

/* Section background dividers */
.section{background:#050505;padding:10px;border-radius:6px}
.humidity{color:#cfdff6;font-size:0.95rem}

/* Sidebar / Weather */
.sidebar .temp{font-size:44px;color:#fff;font-weight:700;margin-bottom:4px}
.info h2{font-size:16px;color:#fff;margin:0 0 4px 0}
.desc{color:#cfdff6;margin-top:6px}
.updated{color:#9fb0d6;font-size:.92rem}
.forecast{margin-top:6px}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{background:#0b0b0b;border-radius:8px;padding:10px;text-align:center;border:0}
.day-name{font-weight:500;margin-bottom:6px;font-size:.95rem}
.temps{font-size:.9rem;opacity:.95}

/* Controls button */
.btn{position:fixed;top:18px;right:18px;z-index:999;background:#111;border:0;padding:8px;border-radius:8px;cursor:pointer;color:#e6eef8;font-weight:600;width:44px;height:44px;display:flex;align-items:center;justify-content:center}

/* Spotify UI */
#spotify-login{position:fixed;bottom:20px;right:20px;z-index:2000;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.03);color:#e6eef8;padding:10px 14px;border-radius:12px;cursor:pointer}
#spotify-now{position:fixed;bottom:20px;left:20px;z-index:2000;display:flex;gap:12px;align-items:center;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px);color:#e6eef8;min-width:220px;max-width:420px}
#sp-cover{width:56px;height:56px;border-radius:8px;flex:0 0 56px;background:#111;object-fit:cover}
#sp-meta{display:flex;flex-direction:column;gap:6px;min-width:0;overflow:hidden}
#sp-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#sp-artist{font-size:12px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#sp-controls button{background:transparent;border:none;color:#e6eef8;cursor:pointer;font-size:16px}
#sp-progress{width:100%;height:5px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden}
#sp-progress-fill{height:100%;width:0%;background:#1DB954}

/* Responsive */
@media (max-width:880px){
  .card{grid-template-columns:1fr}
  .hours{grid-template-columns:repeat(4,1fr)}
  .time{font-size:54px}
}

/* Landscape mode fixes */
@media (orientation:landscape) and (max-height:600px){
  .card{gap:10px;padding:12px}
  .time{font-size:72px}
  .hours{grid-template-columns:repeat(6,1fr);gap:6px}
  .hour{padding:6px;font-size:0.85rem}
  .section{padding:8px}
}

/* Portrait mode on mobile */
@media (orientation:portrait) and (max-width:500px){
  .wrap{padding:16px;gap:12px}
  .time{font-size:80px}
  .hours{grid-template-columns:repeat(3,1fr)}
  .section{padding:8px}
}

</style>
</head>
<body>

<!-- Web Playback SDK -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>

<button class="btn" id="btn" aria-label="Change wallpaper">‚ü≥</button>
<div class="bg" id="bg1"></div>
<div class="bg" id="bg2"></div>

<div class="wrap">
  <div class="card">
    <div class="main">
        <div class="section clock">
          <div class="time" id="time">--:--</div>
          <div class="date" id="date">Loading...</div>
        </div>

        <div class="section">
          <div class="hours" id="hourly">
            <!-- hourly tiles injected here -->
          </div>
        </div>

        <div style="opacity:.9;font-size:.95rem;color:#9fb0d6;margin-top:6px">Use the right panel for full weather + forecast.</div>
    </div>

    <aside class="sidebar">
      <div class="section" style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div class="temp" id="temp">--<span class="unit">¬∞</span></div>
            <div class="info"><h2>Santa Rosa Beach, FL</h2></div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="updated" id="updated">--</div>
          <div class="humidity" id="humidity">Humidity: --%</div>
        </div>
        <div class="desc" id="desc">‚Äî</div>
      </div>

      <div class="section forecast" id="forecast"></div>
    </aside>
  </div>
</div>

<!-- Spotify UI -->
<div id="spotify-now" style="display:none" aria-live="polite">
  <img id="sp-cover" src="" alt="cover"/>
  <div id="sp-meta">
    <div id="sp-title">‚Äî</div>
    <div id="sp-artist">‚Äî</div>

    <div id="sp-progress"><div id="sp-progress-fill"></div></div>

    <div id="sp-controls">
      <button id="sp-prev" title="Previous">‚èÆ</button>
      <button id="sp-play" title="Play/Pause">‚èØ</button>
      <button id="sp-next" title="Next">‚è≠</button>
    </div>
  </div>
  <div id="sp-hide" title="Log out / hide">‚úï</div>
</div>

<button id="spotify-login">Login to Spotify</button>

<script>
/* -------------------- Spotify PKCE & config -------------------- */
const SPOTIFY_CLIENT_ID = '494ccfd29e8c424a84f5f71721f00033';
const REDIRECT_URI = 'https://balsammmmmmmm.github.io/time-weather/callback.html';
// added streaming scope for Web Playback SDK
const SCOPES = 'user-read-currently-playing user-read-playback-state user-modify-playback-state streaming';
const TOKEN_STORAGE_KEY = 'spotify_tokens_v1';

/* ---------- util helpers ---------- */
function randString(length=96){
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
  let s = '';
  const array = new Uint8Array(length);
  crypto.getRandomValues(array);
  for (let i=0;i<length;i++){
    s += chars[array[i] % chars.length];
  }
  return s;
}
function base64urlEncode(buffer){
  let str = '';
  const chunk = 0x8000;
  for (let i=0;i<buffer.length;i+=chunk){
    str += String.fromCharCode.apply(null, Array.from(buffer.slice(i,i+chunk)));
  }
  const b64 = btoa(str);
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function sha256(msg){
  const enc = new TextEncoder();
  const data = enc.encode(msg);
  const h = await crypto.subtle.digest('SHA-256', data);
  return new Uint8Array(h);
}

/* ---------- start authorization ---------- */
async function startAuth(){
  const code_verifier = randString(96);
  localStorage.setItem('spotify_code_verifier', code_verifier);
  const hashed = await sha256(code_verifier);
  const code_challenge = base64urlEncode(hashed);

  const url = new URL('https://accounts.spotify.com/authorize');
  url.searchParams.set('response_type','code');
  url.searchParams.set('client_id', SPOTIFY_CLIENT_ID);
  url.searchParams.set('scope', SCOPES);
  url.searchParams.set('redirect_uri', REDIRECT_URI);
  url.searchParams.set('code_challenge_method', 'S256');
  url.searchParams.set('code_challenge', code_challenge);

  const state = randString(16);
  localStorage.setItem('spotify_auth_state', state);
  url.searchParams.set('state', state);

  window.location.href = url.toString();
}

/* ---------- token storage ---------- */
function saveTokens(tokenObj){
  const now = Date.now();
  const expires_at = now + (tokenObj.expires_in ? tokenObj.expires_in * 1000 : 3600*1000);
  const store = {
    access_token: tokenObj.access_token,
    refresh_token: tokenObj.refresh_token || (getStoredTokens()?.refresh_token || null),
    expires_at
  };
  localStorage.setItem(TOKEN_STORAGE_KEY, JSON.stringify(store));
  return store;
}
function getStoredTokens(){
  try { return JSON.parse(localStorage.getItem(TOKEN_STORAGE_KEY)); } catch(e){ return null; }
}
function clearTokens(){
  localStorage.removeItem(TOKEN_STORAGE_KEY);
  localStorage.removeItem('spotify_code_verifier');
  localStorage.removeItem('spotify_auth_state');
}

/* ---------- refresh token ---------- */
async function refreshAccessToken(){
  const store = getStoredTokens();
  if (!store || !store.refresh_token) return null;
  const body = new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: store.refresh_token,
    client_id: SPOTIFY_CLIENT_ID
  });
  try{
    const r = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: body.toString()
    });
    if (!r.ok) { clearTokens(); updateSpotifyUI(null); return null; }
    const data = await r.json();
    const saved = saveTokens(data);
    return saved;
  }catch(e){ console.error('refresh error', e); return null; }
}

/* -------------------- Spotify now-playing + controls -------------------- */
const loginBtn = document.getElementById('spotify-login');
const spNow = document.getElementById('spotify-now');
const spCover = document.getElementById('sp-cover');
const spTitle = document.getElementById('sp-title');
const spArtist = document.getElementById('sp-artist');
const spProgressFill = document.getElementById('sp-progress-fill');
const spHide = document.getElementById('sp-hide');
const btnPlay = document.getElementById('sp-play');
const btnNext = document.getElementById('sp-next');
const btnPrev = document.getElementById('sp-prev');

let nowPlayingTimer = null;
const pollingInterval = 10000; // 10s
let lastNowData = null;
let lastFetchTime = 0;
let progressTick = null;

/* login button behavior */
loginBtn.addEventListener('click', ()=>{
  const s = getStoredTokens();
  if (s && s.access_token) {
    if (confirm('Log out from Spotify on this page?')) {
      clearTokens();
      updateSpotifyUI(null);
    }
  } else {
    startAuth();
  }
});
spHide.addEventListener('click', ()=>{
  if (getStoredTokens()) {
    if (confirm('Log out from Spotify on this page?')) {
      clearTokens();
      updateSpotifyUI(null);
    }
  } else {
    spNow.style.display = 'none';
  }
});

/* control endpoints (requires a Spotify active device) */
async function callSpotifyEndpoint(method, endpoint, body=null){
  const t = getStoredTokens();
  if (!t) return;
  if (Date.now() > t.expires_at - 5000) {
    const ref = await refreshAccessToken();
    if (!ref) return;
  }
  const token = getStoredTokens().access_token;
  try{
    const r = await fetch('https://api.spotify.com/v1' + endpoint, {
      method,
      headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
      body: body ? JSON.stringify(body) : undefined
    });
    // do not force error handling: endpoints for play/next/prev sometimes return 204
    return r;
  }catch(e){
    console.error('spotify control error', e);
  }
}

/* ---------- Web Playback SDK integration ---------- */
let webPlayer;
let webPlayerDeviceId = null;

window.onSpotifyWebPlaybackSDKReady = () => {
    const token = getStoredTokens()?.access_token;
    if (!token) return;

    webPlayer = new Spotify.Player({
        name: 'TimeWeather Display Player',
        getOAuthToken: cb => { cb(getStoredTokens()?.access_token); },
        volume: 0.5
    });

    webPlayer.addListener('ready', ({ device_id }) => {
        console.log("Web Playback Player Ready:", device_id);
        webPlayerDeviceId = device_id;

        // Make this device the active one (no autoplay)
        callSpotifyEndpoint('PUT', '/me/player', { device_ids: [device_id], play: false });
    });

    webPlayer.addListener('not_ready', ({ device_id }) => {
        console.log('Web Playback Player Offline', device_id);
    });

    // forward player state changes to our UI
    webPlayer.addListener('player_state_changed', state => {
        if (!state) return;
        // build a minimal "now playing" structure compatible with our updateSpotifyUI
        const item = state.track_window?.current_track;
        const data = {
          is_playing: !state.paused,
          progress_ms: state.position,
          item: item ? {
            id: item.id,
            name: item.name,
            duration_ms: item.duration_ms,
            artists: item.artists,
            album: item.album,
            external_urls: { spotify: item.uri }
          } : null
        };
        lastNowData = data;
        lastFetchTime = Date.now();
        updateSpotifyUI(data);
    });

    webPlayer.connect();
};

/* ---------- control handlers (now using web player device when available) ---------- */
btnPlay.onclick = async () => {
  // if web player is ready, route requests to it by setting device_id when playing
  if (webPlayerDeviceId) {
    // toggle using Web API endpoint but target our web player device
    if (lastNowData && lastNowData.is_playing) {
      await callSpotifyEndpoint('PUT', '/me/player/pause', { device_id: webPlayerDeviceId });
    } else {
      await callSpotifyEndpoint('PUT', '/me/player/play', { device_id: webPlayerDeviceId });
    }
    setTimeout(fetchNowPlaying, 600);
    return;
  }
  // fallback to original behavior (external device)
  if (lastNowData && lastNowData.is_playing) {
    await callSpotifyEndpoint('PUT', '/me/player/pause');
  } else {
    await callSpotifyEndpoint('PUT', '/me/player/play');
  }
  setTimeout(fetchNowPlaying, 800);
};
btnNext.onclick = async () => {
  if (webPlayerDeviceId) {
    await callSpotifyEndpoint('POST', '/me/player/next', { device_id: webPlayerDeviceId });
    setTimeout(fetchNowPlaying, 600);
    return;
  }
  await callSpotifyEndpoint('POST', '/me/player/next');
  setTimeout(fetchNowPlaying, 800);
};
btnPrev.onclick = async () => {
  if (webPlayerDeviceId) {
    await callSpotifyEndpoint('POST', '/me/player/previous', { device_id: webPlayerDeviceId });
    setTimeout(fetchNowPlaying, 600);
    return;
  }
  await callSpotifyEndpoint('POST', '/me/player/previous');
  setTimeout(fetchNowPlaying, 800);
};

/* fetch currently-playing */
async function fetchNowPlaying(force=false){
  const store = getStoredTokens();
  if (!store) { updateSpotifyUI(null); return; }
  if (Date.now() > store.expires_at - 5000) {
    const ref = await refreshAccessToken();
    if (!ref) { updateSpotifyUI(null); return; }
  }
  const token = getStoredTokens().access_token;
  try{
    const r = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
      headers: { Authorization: 'Bearer ' + token }
    });
    if (r.status === 204) {
        console.log("No active device ‚Äî trying to activate one‚Ä¶");

        const ok = await activateAnyDevice();
        if (ok) {
            // retry after waking a device
            return fetchNowPlaying(true);
        }

        updateSpotifyUI(null);
        return;
    }

    if (r.status === 401) { const ref = await refreshAccessToken(); if (ref) return fetchNowPlaying(true); updateSpotifyUI(null); return; }
    if (!r.ok) { console.warn('now-playing status', r.status); updateSpotifyUI(null); return; }
    const data = await r.json();
    lastNowData = data;
    lastFetchTime = Date.now();
    updateSpotifyUI(data);
  }catch(e){
    console.error('fetch now playing error', e);
    updateSpotifyUI(null);
  }
}

/* progress animation tick between polls */
function startProgressTick(){
  if (progressTick) clearInterval(progressTick);
  progressTick = setInterval(()=>{
    if (!lastNowData || !lastNowData.progress_ms || !lastNowData.item) return;
    const elapsed = Date.now() - lastFetchTime;
    const current = (lastNowData.progress_ms || 0) + elapsed;
    const duration = lastNowData.item.duration_ms || 1;
    let pct = Math.min(100, (current / duration) * 100);
    spProgressFill.style.width = pct + '%';
    // update play/pause icon subtly
    btnPlay.textContent = lastNowData.is_playing ? '‚è∏' : '‚èØ';
  }, 500);
}
function stopProgressTick(){ if (progressTick) { clearInterval(progressTick); progressTick = null; } }

/* update UI with data from Spotify */
function updateSpotifyUI(data){
  const stored = getStoredTokens();
  // login button text
  loginBtn.textContent = stored && stored.access_token ? 'Logout (Spotify)' : 'Login to Spotify';

  if (!stored) {
    spNow.style.display = 'none';
    stopProgressTick();
    return;
  }

  if (!data || !data.item) {
    spNow.style.display = 'flex';
    spTitle.textContent = 'Not playing';
    spArtist.textContent = '';
    spCover.src = '';
    spProgressFill.style.width = '0%';
    btnPlay.textContent = '‚èØ';
    stopProgressTick();
    return;
  }

  const item = data.item;
  const artists = (item.artists||[]).map(a=>a.name).join(', ');
  const title = item.name || 'Unknown';
  const cover = (item.album && item.album.images && item.album.images[0] && item.album.images[0].url) || '';
  spNow.style.display = 'flex';
  spTitle.textContent = title;
  spArtist.textContent = artists;
  spCover.src = cover;
  // set immediate progress
  const progressMs = data.progress_ms || 0;
  const duration = item.duration_ms || 1;
  const pct = Math.min(100, (progressMs / duration) * 100);
  spProgressFill.style.width = pct + '%';
  btnPlay.textContent = data.is_playing ? '‚è∏' : '‚èØ';
  // start progress tick that will animate between polls
  startProgressTick();
}
// --- Fix: Activate a Spotify device when API returns 204 (no active device) ---
async function activateAnyDevice() {
    try {
        const r = await callSpotifyEndpoint('GET', '/me/player/devices');
        if (!r || !r.ok) return false;
        const d = await r.json();

        if (!d.devices || d.devices.length === 0) return false;

        // pick active device or fallback to the first available
        const dev = d.devices.find(x => x.is_active) || d.devices[0];

        await callSpotifyEndpoint('PUT', '/me/player', {
            device_ids: [dev.id],
            play: false   // don't start music ‚Äî just wake device
        });

        console.log("Activated device:", dev.name);
        return true;
    } catch (e) {
        console.error('activate device error', e);
        return false;
    }
}

/* polling control */
function startPolling(){
  if (nowPlayingTimer) clearInterval(nowPlayingTimer);
  fetchNowPlaying();
  nowPlayingTimer = setInterval(fetchNowPlaying, pollingInterval);
}
function stopPolling(){
  if (nowPlayingTimer) { clearInterval(nowPlayingTimer); nowPlayingTimer = null; }
}

/* init */
(function initSpotify(){
  const s = getStoredTokens();
  if (s && s.access_token) startPolling();
  else spNow.style.display = 'none';
  // Update UI if token present
  if (s) updateSpotifyUI(null);
})();

/* -------------------- Weather + Clock + Background (original code with fixes) -------------------- */
const IMGS=[
'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=3840&q=95',
'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=3840&q=95',
'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=3840&q=95',
'https://images.unsplash.com/photo-1464802686167-b939a6910659?w=3840&q=95',
'https://images.unsplash.com/photo-1517685352821-92cf88aee5a5?w=3840&q=95',
'https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?w=3840&q=95',
'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=3840&q=95',
'https://images.unsplash.com/photo-1511884642898-4c92249e20b6?w=3840&q=95',
'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=3840&q=95',
'https://images.unsplash.com/photo-1510414842594-a61c69b5ae57?w=3840&q=95'
];
let idx=0,act=1;
function rotate(){
  idx=(idx+1)%IMGS.length;
  const n=act===1?bg2:bg1,c=act===1?bg1:bg2;
  n.style.backgroundImage=`url('${IMGS[idx]}')`;
  n.classList.add('active');
  setTimeout(()=>c.classList.remove('active'),100);
  act=act===1?2:1;
}
function schedule(){
  setTimeout(()=>{rotate();schedule()},(60+Math.random()*60)*1e3);
}
bg1.style.backgroundImage=`url('${IMGS[0]}')`;
bg1.classList.add('active');
schedule();
btn.onclick=rotate;

function clock(){
  const d=new Date();
  let h=d.getHours();
  const ap=h>=12?'PM':'AM';
  h=h%12||12;
  time.innerHTML=`${h}:${String(d.getMinutes()).padStart(2,'0')} <span class="ampm">${ap}</span>`;
  date.textContent=d.toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
}
clock();
setInterval(clock,1e3);

/* weather code with timezone/dayfix and icon fallback */
const CODE = {0:['Clear','‚òÄÔ∏è'],1:['Mainly clear','üå§Ô∏è'],2:['Partly cloudy','‚õÖ'],3:['Overcast','‚òÅÔ∏è'],45:['Fog','üå´Ô∏è'],48:['Depositing rime fog','üå´Ô∏è'],51:['Light drizzle','üå¶Ô∏è'],52:['Moderate drizzle','üå¶Ô∏è'],53:['Dense drizzle','üå¶Ô∏è'],56:['Freezing drizzle','üåßÔ∏è'],57:['Dense freezing drizzle','üåßÔ∏è'],61:['Slight rain','üåßÔ∏è'],63:['Moderate rain','üåßÔ∏è'],65:['Heavy rain','üåßÔ∏è'],66:['Freezing rain','üåßÔ∏è'],67:['Heavy freezing rain','üåßÔ∏è'],71:['Slight snow','‚ùÑÔ∏è'],73:['Moderate snow','‚ùÑÔ∏è'],75:['Heavy snow','‚ùÑÔ∏è'],77:['Snow grains','‚ùÑÔ∏è'],80:['Slight rain showers','üå¶Ô∏è'],81:['Moderate rain showers','üå¶Ô∏è'],82:['Violent rain showers','‚õàÔ∏è'],85:['Slight snow showers','üå®Ô∏è'],86:['Heavy snow showers','üå®Ô∏è'],95:['Thunderstorm','‚õàÔ∏è'],96:['Thunderstorm w/ slight hail','‚õàÔ∏è'],99:['Severe thunderstorm','‚õàÔ∏è']};

async function weather(){
  try{
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=30.3938&longitude=-86.2683&current_weather=true&hourly=temperature_2m,weathercode,relativehumidity_2m&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=7`, {cache:'no-store'});
    if(!r.ok) return;
    const d = await r.json();
    if(!d || !d.current_weather) return;
    const cw = d.current_weather;
    const t = Math.round(cw.temperature);
    const m = CODE[cw.weathercode] || ['Unknown','üå°Ô∏è'];
    temp.innerHTML = `${t}<span class="unit">¬∞</span>`;
    desc.textContent = m[0] + (cw.is_day===0 ? ' (night)' : '');
    updated.textContent = new Date().toLocaleString('en-US',{hour:'numeric',minute:'2-digit',weekday:'short',day:'numeric',month:'short'});

    // Build hourly tiles (next 12 hours)
    if (d.hourly && d.hourly.time && d.hourly.temperature_2m){
      let idx = d.hourly.time.indexOf(cw.time);
      if (idx === -1){
        const cwMs = new Date(cw.time).getTime();
        idx = d.hourly.time.findIndex(ti => new Date(ti).getTime() >= cwMs);
        if (idx === -1) idx = 0;
      }
      // humidity: try to read relativehumidity_2m from hourly data if available
      let hum = null;
      if (d.hourly && d.hourly.relativehumidity_2m && d.hourly.relativehumidity_2m.length > idx){
        hum = Math.round(d.hourly.relativehumidity_2m[idx]);
      }
      const humEl = document.getElementById('humidity');
      if (humEl) {
        humEl.textContent = hum !== null ? `Humidity: ${hum}%` : 'Humidity: ‚Äî';
      }
      const hours = [];
      for (let i=idx;i<Math.min(idx+12,d.hourly.time.length);i++){
        const hh = d.hourly.time[i];
        const tempH = Math.round(d.hourly.temperature_2m[i]);
        const codeH = (d.hourly.weathercode && d.hourly.weathercode[i]!==undefined) ? d.hourly.weathercode[i] : null;
        const icon = codeH !== null ? (CODE[codeH] ? CODE[codeH][1] : '') : '';
        const label = new Date(hh).toLocaleTimeString('en-US',{hour:'numeric'});
        hours.push(`<div class="hour"><div class="t">${label}</div><div class="temp">${tempH}¬∞</div><div class="icon" style="margin-top:6px">${icon}</div></div>`);
      }
      hourly.innerHTML = hours.join('');
    }

    // daily forecast build (sidebar)
    if (d.daily && d.daily.time){
      const grid = d.daily.time.map((dt,i)=>{
        const dtMid = dt + "T12:00:00";
        const dd = new Date(dtMid);
        const dn = i===0 ? 'Today' : dd.toLocaleDateString('en-US',{weekday:'short'});
        const wcode = d.daily.weathercode[i];
        const wm = CODE[wcode] || ['Unknown','üå°Ô∏è'];
        const hi = Math.round(d.daily.temperature_2m_max[i]);
        const lo = Math.round(d.daily.temperature_2m_min[i]);
        const iconPath = `./icons/${wcode}.svg`;
        return `<div class="day"><div class="day-name">${dn}</div><div class="icon"><img src="${iconPath}" width="28" onerror="this.onerror=null;this.replaceWith(document.createTextNode('${wm[1]}'))"></div><div class="temps">${hi}¬∞ / ${lo}¬∞</div></div>`;
      }).join('');
      forecast.innerHTML = '<div class="grid">'+grid+'</div>';
    }
  }catch(e){ console.error(e) }
}
weather();
setInterval(weather,3e5);

function layout(){
  const w=innerWidth,h=innerHeight;
  document.body.classList.remove('mobile-portrait','mobile-landscape');
  if(w<=926){
    if(w>h) document.body.classList.add('mobile-landscape');
    else document.body.classList.add('mobile-portrait');
  }
}
layout();
addEventListener('resize',layout);
addEventListener('orientationchange',()=>setTimeout(layout,100));

/* -------------------- small improvement: auto-show spotify bar if login done but hidden -------------------- */
(function restoreSpotifyVisibility(){
  const s = getStoredTokens();
  if (s && s.access_token) {
    document.getElementById('spotify-now').style.display = 'flex';
  }
})();
</script>
</body>
</html>
